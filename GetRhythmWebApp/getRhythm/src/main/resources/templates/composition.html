<!DOCTYPE html>
<!-- html tag with attributes for thymeleaf -->
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="https://www.thymeleaf.org"
	xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity3">

<head>
<!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bootstrap CSS -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
	crossorigin="anonymous">

<!-- Tone.js CDN -->
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.26/Tone.js"
	integrity="sha512-+esjJ8NSEfoB5Sr8R7jTcYxCR1Bd6q9C+WQC0JA2UXVPT8Mlo/TJqqyp0qeeoxFzkAaa8t6tZCHLGmw3oNI2Qg=="
	crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<title>Lessons - Composition</title>

<!-- CSS -->
<link rel="stylesheet" type="text/css" media="all"
	href="/getRhythmStyles.css" />



</head>

<body>

	<div th:replace="layoutElements :: authenticatedNavbar"></div>

	<div class="container">

		<!-- Row1 -->
		<div class="row">

			<div th:replace="layoutElements :: greeting"></div>

			<!-- Heading and instructions -->
			<div class="col-6">
				<h1 class="display-4 text-center">Composition</h1>
			</div>

		</div>

		<!-- Row2 -->

		<div class="row">
			<!-- Instructions -->

			<!-- Start/Stop Button -->
			<div class="d-grid col-1 mx-auto ">
				<button id="startStop" role="switch" aria-checked="false"
					type="button" class="btn btn-primary text-center ">
					<span>Play!</span>
				</button>
			</div>
			<div class="col-2"></div>
			<!-- Instructions -->
			<div class="col-6">
				<h1 class="fs-2 text-center">Drag And Drop To Create Your Own
					Rhythms</h1>
			</div>
			<!-- Rhythms Heading -->
			<div class="col-3">
				<p class="display-6 text-center ">Rhythms:</p>
			</div>
		</div>


		<!-- Row3 -->
		<div class="row p-3 d-flex">

			<!-- Composition Grid -->
			<div class="d-grid col-8 display-2 ">
				<div
					class="container table notation table-bordered text-center compositionTable ">
					<div class="row compositionTableRow ">
						<div id="box1" ondrop="drop(event)" ondragover="allowDrop(event)"
							class="col-sm border d-flex align-items-center justify-content-center"></div>
						<div id="box2" ondrop="drop(event)" ondragover="allowDrop(event)"
							class="col-sm border d-flex align-items-center justify-content-center"></div>
						<div id="box3" ondrop="drop(event)" ondragover="allowDrop(event)"
							class="col-sm border d-flex align-items-center justify-content-center"></div>
						<div id="box4" ondrop="drop(event)" ondragover="allowDrop(event)"
							class="col-sm border d-flex align-items-center justify-content-center"></div>
					</div>
					<div class="row compositionTableRow">
						<div id="box5" ondrop="drop(event)" ondragover="allowDrop(event)"
							class="col-sm border d-flex align-items-center justify-content-center"></div>
						<div id="box6" ondrop="drop(event)" ondragover="allowDrop(event)"
							class="col-sm border d-flex align-items-center justify-content-center"></div>
						<div id="box7" ondrop="drop(event)" ondragover="allowDrop(event)"
							class="col-sm border d-flex align-items-center justify-content-center"></div>
						<div id="box8" ondrop="drop(event)" ondragover="allowDrop(event)"
							class="col-sm border d-flex align-items-center justify-content-center"></div>
					</div>
				</div>
			</div>

			<!-- AvailableRhythms Grid -->
			<div class="d-grid col-4 mx-auto display-4 noSelect"
				draggable="false">
				<div class="container notation" draggable="false">
					<div class="row" draggable="false">
						<div
							class="col-sm border d-flex align-items-center justify-content-center">
							<span id="rhythm1" draggable="true" ondragstart="drag(event)">q
								q</span>
						</div>
						<div
							class="col-sm border d-flex align-items-center justify-content-center">
							<span id="rhythm2" draggable="true" ondragstart="drag(event)">q
								n</span>
						</div>
					</div>
					<div class="row" th:if="${progress}>=2" draggable="false">
						<div
							class="col-sm border d-flex align-items-center justify-content-center"
							th:if="${progress}>=2">
							<span id="rhythm3" draggable="true" ondragstart="drag(event)">n
								q</span>
						</div>
						<div
							class="col-sm border d-flex align-items-center justify-content-center"
							th:if="${progress}>=3">
							<span id="rhythm4" draggable="true" ondragstart="drag(event)">n
								n</span>
						</div>
					</div>
					<div class="row" th:if="${progress}>=4" draggable="false">
						<div
							class="col-sm border d-flex align-items-center justify-content-center"
							th:if="${progress}>=4">
							<span id="rhythm5" draggable="true" ondragstart="drag(event)">h</span>
						</div>
						<div
							class="col-sm border d-flex align-items-center justify-content-center"
							th:if="${progress}>=5">
							<span id="rhythm6" draggable="true" ondragstart="drag(event)">j
								e</span>
						</div>
					</div>
					<div class="row" th:if="${progress}>=6" draggable="false">
						<div
							class="col-sm border d-flex align-items-center justify-content-center"
							th:if="${progress}>=6">
							<span id="rhythm7" colspan="2" draggable="true"
								ondragstart="drag(event)">e q e</span>
						</div>
						<div
							class="col-sm border d-flex align-items-center justify-content-center"></div>
					</div>

				</div>
			</div>

		</div>



		<!-- Row4 -->
		<div class="row">
			<div class="col-4">
				<div th:replace="layoutElements :: signoutButton"></div>
			</div>

			<div class="d-grid col-4 mx-auto"></div>

			<div class="d-grid col-2 mx-auto">
				<a id="back" href="/improvisation" role="button" aria-checked="false"
					class="btn btn-primary text-center "> <span>Back</span>
				</a>
			</div>
			<div class="d-grid col-2 mx-auto">

				<a id="continue" href="/selfAssessment?activity=Composition&next=dictation" role="button"
					aria-checked="false" class="btn btn-primary text-center "> <span>Continue</span>
				</a>
			</div>
		</div>


		<p>
			Debugging: <span id="debug"></span>
		</p>


		<!-- Javascript -->
		<script>
			// Allow content to be dropped into elements
			function allowDrop(ev) {
				ev.preventDefault();
			}

			// on drag copy text data 
			function drag(ev) {
				ev.dataTransfer.setData("text/plain", ev.target.id);
				event.dataTransfer.effectAllowed = "copy";
			}

			// on drop paste data to new node with new id
			function drop(ev) {
				ev.preventDefault();
				var data = ev.dataTransfer.getData("text"); // get Data from drag function
				var newRhythm = document.getElementById(data).cloneNode(true); // get node by ID, clone it and assign a new variable
				newRhythm.id = newRhythm.id + "copy"; // create new note name
				// update debugging output
				document.getElementById("debug").innerHTML = part.length;
				// if statement to handle replacing previously dropped rhythms
				// if target has nodes remove them and append the new rhythm to the div
				if (ev.target.hasChildNodes()) {
					var divName = ev.target.parentNode;
						ev.target.remove();
						divName.appendChild(newRhythm);
				} else{
					// otherwise just append the rhythm to the div
					ev.target.appendChild(newRhythm);
				}
			}
			
			// tone.js script to play rhythms
			/* Listener for start stop button */
			var startStopButton = document.querySelector("#startStop");
			startStopButton.addEventListener("click", function() {
				startTransport(); // Start the transport control
			})
			var tempo = 80; // default tempo
			var playing = false; // boolean to track whether transport playing or not. 
			
			// Create synth to play sound
			const synth = new Tone.MembraneSynth().toDestination(); //Membrane drum synthesizer
			
			// Part sets up sound pattern to be played and includes visual sync
			const part = new Tone.Part(function(time, pitch){	

						
				// play the note
				synth.triggerAttackRelease(pitch, "8n", time+("0.1")); // play an 8th note at the pitch and time passed in
			
			}, ); // Default note values
			
			// start the part
			part.start();		

			// function to add the notes to be played to the part based on the composition created by the user
			function addRhythms(){
				
				// loop for each box of the composition page
				for (var barNo = 0; barNo <=7; barNo++){
					// get the box to be checked
					var box = document.getElementById("box"+(barNo+1));


					if (box.hasChildNodes()){
						// get the id of the rhythm inside the box to be checked
						var boxRhythm = box.firstChild.id;
						// compare the id against the given strings and append the relevant rhythm patterns
						if (boxRhythm == "rhythm1copy"){
							part.add(barNo+":0:0", "C2");
				  			part.add(barNo+":1:0", "C2");
						} else if (boxRhythm == "rhythm2copy") {
							part.add(barNo+":0:0", "C2");
							part.add(barNo+":1:0", "C2");
							part.add(barNo+":1:2", "C2");
						} else if (boxRhythm == "rhythm3copy") {
							part.add(barNo+":0:0", "C2");
							part.add(barNo+":0:2", "C2");
							part.add(barNo+":1:0", "C2");
						} else if (boxRhythm == "rhythm4copy") {
							part.add(barNo+":0:0", "C2");
							part.add(barNo+":0:2", "C2");
							part.add(barNo+":1:0", "C2");
							part.add(barNo+":1:2", "C2");
						} else if (boxRhythm == "rhythm5copy") {
							part.add(barNo+":0:0", "C2");
						} else if (boxRhythm == "rhythm6copy") {
							part.add(barNo+":0:0", "C2");
							part.add(barNo+":1:2", "C2");
						} else if (boxRhythm == "rhythm7copy") {
							part.add(barNo+":0:0", "C2");
							part.add(barNo+":0:2", "C2");
							part.add(barNo+":1:2", "C2");
						}	
						
					}
				
				}
			}
								
			// Set the time signature
			Tone.Transport.set({
				"timeSignature" : "2", 
			});
			
	 		/* Start Transport Function */
			function startTransport() {
				
				/* If transport is not playing, start it, otherwise stop it */
				if (!playing) {
 					part.clear();
					addRhythms(); 
		 			Tone.start(); // Start Tone.js - required by browser before allowing audio to play
					playing = true; // Set playing boolean to true
					Tone.Transport.bpm.value = tempo; // Set the bpm to the current tempo
					Tone.Transport.start("+.3"); // Start the transport 300ms in the future to help with audio latency
					
				
					
				} else {
					Tone.Transport.stop(); // Stop the transport
					Tone.Transport.cancel(); // cancel all transport events
					playing = false; // Set playing boolean to false					
				}
				
			}	
			
		</script>

		<!-- Bootstrap JavaScript -->
		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
			integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
			crossorigin="anonymous"></script>
</body>
</html>